# Отчёт о тестировании CI/CD Pipeline

**Дата тестирования:** 25 ноября 2025 г.  
**Проект:** Actions  
**Репозиторий:** https://github.com/avkorolyov/Actions  
**Сервер:** 194.58.126.39:5001

## Оглавление

- [1. Цель тестирования](#1-цель-тестирования)
- [2. Тестовое окружение](#2-тестовое-окружение)
- [3. Настройка секретов](#3-настройка-секретов)
- [4. Тестирование CI/CD Pipeline](#4-тестирование-cicd-pipeline)
- [5. Тестирование API эндпоинтов](#5-тестирование-api-эндпоинтов)
- [6. Проверка контейнера на сервере](#6-проверка-контейнера-на-сервере)
- [7. Сводная таблица результатов](#7-сводная-таблица-результатов)
- [8. Выявленные проблемы и решения](#8-выявленные-проблемы-и-решения)
- [9. Заключение](#9-заключение)

---

## 1. Цель тестирования

Проверить работоспособность CI/CD pipeline, включающего:
- Автоматическую сборку Docker-образа при push в ветку `main`
- Публикацию образа в GitHub Container Registry (ghcr.io)
- Автоматический деплой на удалённый сервер через SSH

---

## 2. Тестовое окружение

### Локальная машина
- **ОС:** macOS (darwin 25.1.0)
- **Python:** 3.13
- **Git:** установлен
- **SSH-ключ:** `~/.ssh/deploy_key` (ed25519, без passphrase)

### Сервер
- **ОС:** Ubuntu 24.04.3 LTS
- **Docker:** 28.5.1
- **IP:** 194.58.126.39
- **Пользователь:** deploy (в группе docker)

### GitHub
- **Репозиторий:** avkorolyov/Actions
- **Workflow:** `.github/workflows/deploy.yml`
- **Container Registry:** ghcr.io/avkorolyov/actions

---

## 3. Настройка секретов

В репозитории настроены следующие секреты:

| Секрет | Статус | Описание |
|--------|--------|----------|
| `SSH_HOST` | ✅ Настроен | 194.58.126.39 |
| `SSH_USER` | ✅ Настроен | deploy |
| `SSH_PRIVATE_KEY` | ✅ Настроен | Приватный ключ ed25519 |
| `GITHUB_TOKEN` | ✅ Автоматический | Для push в ghcr.io |

---

## 4. Тестирование CI/CD Pipeline

### 4.1 Первый запуск (с ошибкой)

**Коммит:** `5f5a57c` — "Initial commit: Flask app with CI/CD"

**Результат:**
- ✅ Job "Build and Push Docker Image" — **Succeeded** (18 сек)
- ❌ Job "Deploy to Server" — **Failed** (6 сек)

**Причина ошибки:**
```
invalid reference format: repository name (avkorolyov/Actions) must be lowercase
```

**Анализ:** Docker требует имена образов в нижнем регистре. Переменная `github.repository` возвращала `avkorolyov/Actions` с заглавной буквой.

### 4.2 Второй запуск (та же ошибка)

**Коммит:** `f7b0985` — "Test CI/CD workflow"

**Результат:**
- ✅ Job "Build and Push Docker Image" — **Succeeded** (24 сек)
- ❌ Job "Deploy to Server" — **Failed** (6 сек)

**Причина:** Ошибка не была исправлена, workflow запустился с тем же кодом.

### 4.3 Исправление и успешный запуск

**Коммит:** "Fix: lowercase repository name for Docker"

**Изменения в `deploy.yml`:**
- Заменено `ghcr.io/${{ github.repository }}` на `ghcr.io/avkorolyov/actions`

**Результат:**
- ✅ Job "Build and Push Docker Image" — **Succeeded**
- ✅ Job "Deploy to Server" — **Succeeded**

---

## 5. Тестирование API эндпоинтов

После успешного деплоя проведено тестирование всех эндпоинтов приложения.

### 5.1 Главная страница (/)

**Запрос:**
```bash
curl http://194.58.126.39:5001/
```

**Ответ:**
```json
{
  "message": "Минимальная конфигурация приложения работает",
  "endpoints": {
    "/": "Описание сервиса и список эндпоинтов",
    "/health": "Проверка готовности контейнера",
    "/info": "Метаданные о приложении",
    "/env": "Сводка ключевых переменных окружения",
    "/multiply/<a>/<b>": "Умножение двух чисел",
    "/divide/<a>/<b>": "Деление двух чисел"
  }
}
```

**Статус:** ✅ Passed

### 5.2 Проверка здоровья (/health)

**Запрос:**
```bash
curl http://194.58.126.39:5001/health
```

**Ответ:**
```json
{
  "status": "ok",
  "details": "Контейнер отвечает на запросы"
}
```

**Статус:** ✅ Passed

### 5.3 Информация о приложении (/info)

**Запрос:**
```bash
curl http://194.58.126.39:5001/info
```

**Ответ:**
```json
{
  "app": "my-flask-app",
  "version": "1.0.0",
  "port": "5001"
}
```

**Статус:** ✅ Passed

### 5.4 Переменные окружения (/env)

**Запрос:**
```bash
curl http://194.58.126.39:5001/env
```

**Ответ:**
```json
{
  "env": {
    "PORT": "5001",
    "HOSTNAME": "a91ba810e4b2"
  }
}
```

**Статус:** ✅ Passed

### 5.5 Умножение (/multiply/3/4)

**Запрос:**
```bash
curl http://194.58.126.39:5001/multiply/3/4
```

**Ответ:**
```json
{
  "operation": "multiply",
  "a": 3.0,
  "b": 4.0,
  "result": 12.0
}
```

**Статус:** ✅ Passed

### 5.6 Деление (/divide/10/2)

**Запрос:**
```bash
curl http://194.58.126.39:5001/divide/10/2
```

**Ответ:**
```json
{
  "operation": "divide",
  "a": 10.0,
  "b": 2.0,
  "result": 5.0
}
```

**Статус:** ✅ Passed

---

## 6. Проверка контейнера на сервере

**Команда:**
```bash
ssh -i ~/.ssh/deploy_key deploy@194.58.126.39 "docker ps | grep my-flask-app"
```

**Результат:**
```
CONTAINER ID   IMAGE                              COMMAND           STATUS    PORTS                    NAMES
a91ba810e4b2   ghcr.io/avkorolyov/actions:latest  "python app.py"   Up        0.0.0.0:5001->5001/tcp   my-flask-app
```

**Статус:** ✅ Контейнер работает

---

## 7. Сводная таблица результатов

| Компонент | Тест | Результат |
|-----------|------|-----------|
| GitHub Actions | Сборка Docker-образа | ✅ Passed |
| GitHub Actions | Push в ghcr.io | ✅ Passed |
| GitHub Actions | Деплой через SSH | ✅ Passed |
| API | GET / | ✅ Passed |
| API | GET /health | ✅ Passed |
| API | GET /info | ✅ Passed |
| API | GET /env | ✅ Passed |
| API | GET /multiply/3/4 | ✅ Passed |
| API | GET /divide/10/2 | ✅ Passed |
| Docker | Контейнер запущен | ✅ Passed |

---

## 8. Выявленные проблемы и решения

### Проблема 1: Ошибка push в GitHub из-за отсутствия scope `workflow`

**Описание:** При первом push репозиторий отклонил изменения с ошибкой:
```
refusing to allow a Personal Access Token to create or update workflow without `workflow` scope
```

**Решение:** Обновлён Personal Access Token с добавлением scope `workflow`.

### Проблема 2: SSH-ключ с passphrase

**Описание:** Приватный ключ `~/.ssh/dev` был защищён passphrase, что делало невозможным автоматическое подключение в GitHub Actions.

**Решение:** Создан новый SSH-ключ без passphrase:
```bash
ssh-keygen -t ed25519 -f ~/.ssh/deploy_key -N ""
```

### Проблема 3: Имя репозитория с заглавной буквой

**Описание:** Docker требует имена образов в нижнем регистре. `avkorolyov/Actions` вызывал ошибку.

**Решение:** В `deploy.yml` заменено динамическое имя на статическое `ghcr.io/avkorolyov/actions:latest`.

---

## 9. Заключение

CI/CD pipeline полностью работоспособен. Все тесты пройдены успешно.

**Итоговый статус:** ✅ **PASSED**

При каждом push в ветку `main`:
1. ✅ Автоматически собирается Docker-образ
2. ✅ Образ публикуется в GitHub Container Registry
3. ✅ Приложение деплоится на сервер через SSH
4. ✅ Приложение доступно по адресу http://194.58.126.39:5001/


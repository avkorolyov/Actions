# План реализации проекта CI/CD с GitHub Actions

## Важное примечание о секретах

### Разница между GITHUB_TOKEN и SSH для деплоя

**GITHUB_TOKEN:**
- Используется для аутентификации в GitHub Container Registry (ghcr.io)
- Применяется в GitHub Actions runner для push Docker-образа в реестр
- Уже существует в вашем репозитории (использовался в проекте pdf_generator)

**SSH (SSH_PRIVATE_KEY, SSH_HOST, SSH_USER):**
- Используется для подключения к серверу, на который деплоится приложение
- Применяется через SSH-Action для выполнения команд на удаленном сервере
- Обязателен согласно требованиям: "Деплой должен выполняться через SSH-Action"

**Вывод:** 
- `GITHUB_TOKEN` и SSH используются для разных задач и оба необходимы
- Использование `GITHUB_TOKEN` вместо SSH для деплоя **противоречит требованиям**, так как в требованиях явно указано использование SSH-Action
- `GITHUB_TOKEN` нужен для публикации образа, SSH - для деплоя на сервер

---

## Описание приложения

Приложение уже существует в `/Users/leo/Documents/Cursor/my-flask-app` и представляет собой REST API на Python с использованием стандартной библиотеки `http.server` (BaseHTTPRequestHandler).

### Базовая функциональность приложения:

**Эндпоинты:**
- `/` — Главная страница со списком всех доступных эндпоинтов
- `/health` — Проверка здоровья приложения (возвращает статус "ok")
- `/info` — Метаданные о приложении (название, версия, порт)
- `/env` — Сводка ключевых переменных окружения (PORT, HOSTNAME)
- `/multiply/<a>/<b>` — Умножение двух чисел (a * b)
- `/divide/<a>/<b>` — Деление двух чисел (a / b) с проверкой деления на ноль

**Технические детали:**
- Python 3.12 с использованием `http.server.BaseHTTPRequestHandler`
- Порт по умолчанию: 5001 (настраивается через переменную окружения PORT)
- Все ответы в формате JSON
- Обработка ошибок для некорректных запросов

---

## Шаг 1: Копирование приложения в проект

**Ответственный:** AI (Auto)

**Действия:**
- Скопировать файл `app.py` из `/Users/leo/Documents/Cursor/my-flask-app/app.py` в корень проекта
- Проверить совместимость кода
- При необходимости адаптировать под требования проекта

**Ожидаемый результат (артефакты):**
- `app.py` - файл с кодом приложения в корне проекта

---

## Шаг 2: Подготовка зависимостей и конфигурации

**Ответственный:** AI (Auto)

**Действия:**
- Создать файл `requirements.txt` (приложение использует только стандартную библиотеку Python, файл может быть пустым или содержать только комментарий)
- Создать файл `.gitignore` для исключения ненужных файлов из репозитория (venv, __pycache__, .env и т.д.)

**Ожидаемый результат (артефакты):**
- `requirements.txt` - список зависимостей Python (может быть пустым)
- `.gitignore` - файл для исключения файлов из Git

---

## Шаг 3: Создание Dockerfile

**Ответственный:** AI (Auto)

**Действия:**
- Скопировать или адаптировать `Dockerfile` из `/Users/leo/Documents/Cursor/my-flask-app/Dockerfile`
- Проверить корректность настройки порта (5001)
- Убедиться, что команда запуска приложения корректна

**Ожидаемый результат (артефакты):**
- `Dockerfile` - файл для сборки Docker-образа

---

## Шаг 4: Создание структуры GitHub Actions workflow

**Ответственный:** AI (Auto)

**Действия:**
- Создать папку `.github/workflows`
- Создать файл `deploy.yml` с базовой структурой workflow
- Настроить триггер на push в ветку `main`

**Ожидаемый результат (артефакты):**
- `.github/workflows/deploy.yml` - файл workflow с базовой структурой

---

## Шаг 5: Настройка job для сборки Docker-образа

**Ответственный:** AI (Auto)

**Действия:**
- Добавить job `build` в workflow
- Настроить checkout кода
- Настроить сборку Docker-образа
- Настроить логин в GitHub Container Registry используя существующий `GITHUB_TOKEN` (секрет уже настроен в репозитории)
- Настроить push образа в ghcr.io

**Ожидаемый результат (артефакты):**
- Обновленный `.github/workflows/deploy.yml` с job для сборки и публикации образа

---

## Шаг 6: Создание репозитория на GitHub и настройка секретов

**Ответственный:** Пользователь

### 6.1 Создание нового репозитория на GitHub

1. Откройте https://github.com/new
2. Заполните поля:
   - **Repository name:** `Actions` (или другое имя)
   - **Description:** CI/CD pipeline с GitHub Actions
   - **Visibility:** Public или Private
3. **НЕ** ставьте галочки на "Add a README file", "Add .gitignore", "Choose a license" — у нас уже есть эти файлы
4. Нажмите **"Create repository"**
5. GitHub покажет инструкции. Выполните команды для существующего репозитория:
   ```bash
   cd /Users/leo/Documents/Cursor/Actions
   git init
   git add .
   git commit -m "Initial commit: Flask app with CI/CD"
   git branch -M main
   git remote add origin https://github.com/YOUR_USERNAME/Actions.git
   git push -u origin main
   ```

### 6.2 Настройка секретов в GitHub

1. Перейдите в созданный репозиторий на GitHub
2. Нажмите **Settings** (вкладка в верхней части страницы репозитория)
3. В левом меню выберите **Secrets and variables → Actions**
4. Нажмите **"New repository secret"** и добавьте секреты:

| Имя секрета | Значение | Описание |
|-------------|----------|----------|
| `SSH_HOST` | IP-адрес или домен сервера | Например: `192.168.1.100` или `server.example.com` |
| `SSH_USER` | `deploy` | Имя пользователя для SSH (создадим на следующем шаге) |
| `SSH_PRIVATE_KEY` | Содержимое `~/.ssh/dev` | Скопируйте полностью, включая `-----BEGIN...` и `-----END...` |
| `GHCR_TOKEN` | PAT с правами `read:packages` | (опционально) Для pull приватных образов на сервере |

**Примечание:** `GITHUB_TOKEN` создаётся автоматически для каждого workflow и не требует ручной настройки.

**Ожидаемый результат (артефакты):**
- Созданный репозиторий на GitHub
- Настроенные секреты в GitHub:
  - `SSH_PRIVATE_KEY` - приватный SSH-ключ
  - `SSH_HOST` - адрес сервера для деплоя
  - `SSH_USER` - имя пользователя для SSH-подключения (deploy)

---

## Шаг 7: Настройка job для деплоя на сервер

**Ответственный:** AI (Auto)

**Действия:**
- Добавить job `deploy` в workflow
- Настроить зависимость от job `build`
- Настроить использование SSH-Action для подключения к серверу (обязательно согласно требованиям)
- Добавить команды для:
  - Остановки старого контейнера (если существует)
  - Аутентификации в GitHub Container Registry на сервере (для pull образа)
  - Загрузки нового образа из ghcr.io
  - Запуска нового контейнера
  - Очистки старых образов

**Важно:** 
- Деплой должен выполняться через SSH-Action (требование из Требования.md)
- `GITHUB_TOKEN` не может заменить SSH для доступа к серверу - это разные механизмы:
  - `GITHUB_TOKEN` используется в GitHub Actions для push образа в GHCR
  - SSH используется для подключения к серверу и выполнения команд деплоя

**Ожидаемый результат (артефакты):**
- Обновленный `.github/workflows/deploy.yml` с полным job для деплоя через SSH

---

## Шаг 8: Подготовка сервера для деплоя

**Ответственный:** Пользователь

### 8.1 Создание пользователя deploy на сервере

Подключитесь к серверу под root и выполните команды:

```bash
# 1. Создать пользователя deploy
adduser deploy

# 2. Добавить пользователя в группу docker (для запуска Docker без sudo)
usermod -aG docker deploy

# 3. Создать директорию .ssh для пользователя deploy
mkdir -p /home/deploy/.ssh
chmod 700 /home/deploy/.ssh

# 4. Добавить публичный ключ в authorized_keys
# Скопируйте содержимое вашего ~/.ssh/dev.pub и вставьте в файл:
nano /home/deploy/.ssh/authorized_keys
# Или одной командой (замените YOUR_PUBLIC_KEY на содержимое dev.pub):
echo "YOUR_PUBLIC_KEY" >> /home/deploy/.ssh/authorized_keys

# 5. Установить правильные права
chmod 600 /home/deploy/.ssh/authorized_keys
chown -R deploy:deploy /home/deploy/.ssh

# 6. Проверить, что Docker установлен
docker --version

# 7. Если Docker не установлен, установите его:
# Для Ubuntu/Debian:
apt update
apt install -y docker.io
systemctl enable docker
systemctl start docker
```

### 8.2 Проверка SSH-доступа

С локальной машины проверьте подключение:

```bash
ssh -i ~/.ssh/dev deploy@YOUR_SERVER_IP
```

Если подключение успешно — пользователь настроен правильно.

### 8.3 Проверка прав Docker

После подключения под пользователем deploy:

```bash
docker ps
```

Если команда выполняется без ошибок — права настроены правильно.

### 8.4 Настройка firewall (опционально)

Если на сервере включен firewall, откройте порт 5001:

```bash
# Для UFW (Ubuntu):
ufw allow 5001/tcp

# Для firewalld (CentOS/RHEL):
firewall-cmd --permanent --add-port=5001/tcp
firewall-cmd --reload
```

**Ожидаемый результат (артефакты):**
- Пользователь `deploy` создан на сервере
- Пользователь `deploy` добавлен в группу `docker`
- Публичный SSH-ключ добавлен в `/home/deploy/.ssh/authorized_keys`
- SSH-подключение под пользователем `deploy` работает
- Docker установлен и доступен для пользователя `deploy`

---

## Шаг 9: Тестирование workflow

**Ответственный:** Пользователь

**Действия:**
- Создать ветку `main` (если не существует)
- Сделать push изменений в ветку `main`
- Проверить выполнение workflow в разделе Actions на GitHub
- Проверить успешную сборку и публикацию образа в GitHub Container Registry
- Проверить успешный деплой на сервер
- Проверить работоспособность приложения на сервере

**Ожидаемый результат (артефакты):**
- Успешно выполненный workflow
- Опубликованный Docker-образ в ghcr.io
- Работающее приложение на сервере

---

## Шаг 10: Документация (опционально)

**Ответственный:** AI (Auto) или Пользователь

**Действия:**
- Создать `README.md` с описанием проекта
- Добавить инструкции по запуску и деплою
- Описать структуру проекта

**Ожидаемый результат (артефакты):**
- `README.md` - документация проекта

---

## Итоговая структура проекта

После выполнения всех шагов проект должен содержать:

```
.
├── .github/
│   └── workflows/
│       └── deploy.yml
├── app.py (или main.py)
├── requirements.txt
├── Dockerfile
├── .gitignore
├── README.md (опционально)
└── docs/
    └── Требования.md
```

